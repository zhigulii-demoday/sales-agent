<div align='center'>
  <h1>Проект "Napoleon IT Отзывы | Sales Agent"</h1>
  <p>В данном файле описано устройство проекта и даны рекомендации по его развитию и поддержке. Этот файл должен актуализироваться руководителем группы разработки и дополняться новыми сведениями по мере развития проекта.</p>
</div>

## Содержание
 
1. [Описание проекта](#Описание-проекта)
2. [Основной функционал](#Основной-функционал)
3. [Основные маршруты API](#Основные-маршруты-API)
4. [Требования](#Требования)
5. [Шаги по установке](#Шаги-по-установке)
6. [Описание файла ENV](#Описание-файла-ENV)
7. [Безопасность](#Безопасность)
8. [Дополнительные возможности](#Дополнительные-возможности)


### Описание проекта
Проект направлен на создание универсального агента продаж, использующего большие языковые модели (LLM), для автоматизации процесса взаимодействия с компаниями от имени Napoleon IT. Основной продукт, который предлагает агент, — это Napoleon IT Отзывы, анализатор отзывов на товары с маркетплейсов. Агент автоматически инициирует общение с потенциальными клиентами и отвечает на их вопросы по продукту вплоть до назначения встречи - только на этом моменте подключается менеджер по продажам от компании.

### Основной функционал
Автоматизация общения с потенциальными клиентами через email и Telegram на основе заранее заданных скриптов.
Анализ отзывов на товары с маркетплейсов с использованием данных продукта Napoleon IT Отзывы.
Предоставление информации о продукте, ответы на запросы и создание логов общения.
Контролируемые беседы, сфокусированные на релевантных темах.
Продукт позволяет позволяет значительно сократить объем ручного труда при инициировании и поддержании бесед с клиентами.

### Основные маршруты API

#### 1. Платформы

**GET /platforms**  
Возвращает список всех доступных платформ.

**GET /platforms/{id}**  
Возвращает информацию о конкретной платформе по ее `id`.

**POST /platforms**  
Создает новую платформу.  
**Тело запроса:**
```json
{
  "name": "Название платформы"
}
```

#### 2. Компании

**GET /companies**  
Возвращает список всех компаний.

**GET /companies/{id}**  
Возвращает информацию о конкретной компании по ее `id`.

**POST /companies**  
Создает новую компанию.  
**Тело запроса:**
```json
{
  "name": "Название компании",
  "description": "Описание компании"
}
```

#### 3. Логи

**GET /logs**  
Получает логи сообщений для указанной платформы и пользователя.  
**Параметры запроса:**
- `platform`: Тип платформы (например, `tg`, `mail`).
- `platform_user`: Идентификатор пользователя на платформе (например, ID в Telegram или Email).

**POST /logs**  
Сохраняет лог сообщения.  
**Тело запроса:**
```json
{
  "platform": "tg",
  "platform_user": "user123",
  "platform_message_id": "message123",
  "is_user_message": true,
  "message": "Текст сообщения"
}
```

#### 4. Сообщения

**POST /messages/send-message**  
Отправляет сообщение через Telegram или Email.  
**Тело запроса:**
```json
{
  "username": "email@domain.com",
  "text": "Текст сообщения",
  "chat_type": "mail",
  "subject": "Тема сообщения",
  "message_id": "12345"
}
```

**POST /messages/delete-from-cache**  
Удаляет пользователя из кеша по его имени или Email.  
**Тело запроса:**
```json
{
  "username": "email@domain.com"
}
```

---

### Требования:
- **Python 3.x**
- **FastAPI**
- **SQLAlchemy**
- **Docker**

### Шаги по установке:

1. **Клонирование репозитория**:
   ```bash
   git clone <repository-url>
   cd <project-directory>
   ```

2. **Установка зависимостей**:
   ```bash
   pip install poetry
   poetry install
   ```

3. **Запуск с Docker**:
   ```bash
   docker-compose up
   ```

4. **Запуск приложения (фронт)**:
   ```bash
   streamlit run front.py
   ```

### Шаги по установке модели:

1. **Клонирование репозитория**:
   ```bash
   git clone <repository-url>
   cd <project-directory>
   ```

2. **Установка зависимостей**:
   ```bash
   pip install poetry &&
   poetry install &&
   pip install python-multipart &&
   poetry add flashinfer -i https://flashinfer.ai/whl/cu121/torch2.4/ &&
   pip install sglang &&
   CMAKE_ARGS="-DLLAVA_BUILD=OFF" pip install -U llama-cpp-python
   ```

3. **Запуск модели**:
   ```bash
   python -m sglang.launch_server --model-path NousResearch/Meta-Llama-3.1-8B-Instruct --port 30000 --dtype bfloat16 --quantization fp8 --mem-fraction-static 0.931 --disable-cuda-graph --host 0.0.0.0
   ```

### Описание файла ENV

Файл `.env` содержит конфиденциальные настройки окружения, которые необходимы для правильной работы API. При настройке системы необходимо заполнить следующие параметры:

- **Clickhouse**
  - `CLICKHOUSE_DB`: Имя базы данных Clickhouse.
  - `CLICKHOUSE_USER`: Имя пользователя Clickhouse.
  - `CLICKHOUSE_PASSWORD`: Пароль пользователя Clickhouse.

- **PostgreSQL**
  - `POSTGRES_DB`: Имя базы данных PostgreSQL.
  - `POSTGRES_USER`: Имя пользователя базы данных.
  - `POSTGRES_PASSWORD`: Пароль для доступа к базе данных.

- **Email**
  - `EMAIL_ACCOUNT`: Аккаунт электронной почты для отправки сообщений.
  - `APP_PASSWORD`: Пароль приложения для Email (используется для SMTP/IMAP).

- **IMAP/SMTP**
  - `IMAP_SERVER`: Сервер для входящих сообщений (IMAP).
  - `IMAP_PORT`: Порт для IMAP-сервера.
  - `SMTP_SERVER`: Сервер для исходящих сообщений (SMTP).
  - `SMTP_PORT`: Порт для SMTP-сервера.

- **Telegram**
  - `TELEGRAM_API_ID`: API ID для Telegram.
  - `TELEGRAM_API_HASH`: API Hash для Telegram.
  - `PHONE_NUMBER`: Номер телефона, связанный с Telegram-аккаунтом.

- **Общие параметры**
  - `BASE_API_URL`: Базовый URL для API.
  - `CACHE_FILE`: Файл для кеширования данных.

Заполните эти параметры в файле `.env`, чтобы обеспечить корректную работу системы.

---

### Безопасность

- API поддерживает CORS для взаимодействия с фронтендом.
- Маршруты защищены и требуют валидных данных для взаимодействия с платформами.

---

### Дополнительные возможности

- Логи сообщений сохраняются в базе данных Clickhouse для последующего анализа.
- Поддержка интеграции с Telegram и Email.
